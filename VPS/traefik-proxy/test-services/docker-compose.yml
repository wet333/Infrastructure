version: "3.8"

services:
  whoami:
    image: traefik/whoami
    container_name: test-whoami
    restart: "no"
    networks:
      - traefik-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.test-whoami.rule=Host(`${TEST_HOST}`) && PathPrefix(`/whoami`)"
      - "traefik.http.routers.test-whoami.priority=10"
      - "traefik.http.routers.test-whoami.entrypoints=websecure"
      - "traefik.http.routers.test-whoami.tls.certresolver=le-resolver"
      - "traefik.http.routers.test-whoami.middlewares=whoami-strip"
      - "traefik.http.middlewares.whoami-strip.stripprefix.prefixes=/whoami"
      - "traefik.http.services.test-whoami.loadbalancer.server.port=80"

  nginx:
    image: nginx:alpine
    container_name: test-nginx
    restart: "no"
    volumes:
      - "./html:/usr/share/nginx/html:ro"
    networks:
      - traefik-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.test-nginx.rule=Host(`${TEST_HOST}`)"
      - "traefik.http.routers.test-nginx.priority=1"
      - "traefik.http.routers.test-nginx.entrypoints=websecure"
      - "traefik.http.routers.test-nginx.tls.certresolver=le-resolver"
      - "traefik.http.services.test-nginx.loadbalancer.server.port=80"

networks:
  traefik-net:
    external: true
